{% extends 'base.html' %}

{% block title %}{{ joke['title'] }}{% endblock %}

{% block header %}
<div class="page-header">
  <h1>{{ joke['title'] }}</h1>
  <div class="actions">
    {% if g.user and g.user['userRole'] == 0 %}
      <a class="btn btn-secondary" href="{{ url_for('jokes.takeAJoke') }}">Browse Jokes</a>
      <a class="btn btn-primary" href="{{ url_for('jokes.create') }}">Leave a Joke</a>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block content %}
  <article class="card">
    <div class="card-meta mb-2">
      by <strong>{{ joke['nickname'] }}</strong> on {{ joke['created'].strftime('%Y-%m-%d') }}
      &middot;
      {% if joke['numberOfRatings'] > 0 %}
        <span class="rating-badge">{{ (joke['ratings'] / joke['numberOfRatings']) | round(2) }} / 10</span>
        <span class="text-secondary">({{ joke['numberOfRatings'] }} rating{{ 's' if joke['numberOfRatings'] != 1 }})</span>
      {% else %}
        <span class="rating-badge no-rating">No ratings yet</span>
      {% endif %}
    </div>

    <div class="card-body">{{ joke['body'] }}</div>

    {% if g.user['id'] == joke['author_id'] or g.user['userRole'] == 1 %}
      <div class="card-actions mt-2">
        <a class="btn btn-sm btn-secondary" href="{{ url_for('jokes.update', id=joke['id']) }}">Edit</a>
        <form action="{{ url_for('jokes.delete', id=joke['id']) }}" method="post" style="display:inline;">
          <button class="btn btn-sm btn-danger" type="submit" onclick="return confirm('Are you sure you want to delete this joke?');">Delete</button>
        </form>
      </div>
    {% else %}
      <div class="rating-form">
        <form method="post" action="{{ url_for('jokes.rate_joke', joke_id=joke['id']) }}" style="display:flex; align-items:center; gap:0.75rem;">
          <label for="rating">Rate this joke (1-10):</label>
          <input type="number" name="rating" id="rating" min="1" max="10" required>
          <button type="submit" class="btn btn-sm btn-primary">Submit Rating</button>
        </form>
      </div>
    {% endif %}
  </article>
{% endblock %}
